name: Windows - Chrome Remote Desktop

on:
  workflow_dispatch:
    inputs:
      google_command:
        description: 'Paste the ENTIRE command line from Google here'
        required: true
      access_pin:
        description: 'Enter the 6-digit PIN you want to use for this connection'
        required: true

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
      - name: Download Keep-Alive Script
        shell: cmd
        run: |
          curl.exe -L -o time.py "https://www.dropbox.com/scl/fi/ox42qglbf6fsnm9erf8cw/timelimit.py?rlkey=opyeqgum1k95kud81xlc7d66r&dl=1"
          pip install psutil --quiet

      - name: Install and Configure Chrome Remote Desktop
        env:
          GOOGLE_COMMAND: ${{ github.event.inputs.google_command }}
          ACCESS_PIN: ${{ github.event.inputs.access_pin }}
        shell: powershell
        run: |
          Write-Host "[!] Downloading Chrome Remote Desktop Host..."
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd_host.msi"
          
          Write-Host "[!] Installing Host Service..."
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i crd_host.msi /quiet" -Wait

          # --- NEW: Verify that the host executable exists after installation ---
          $hostExePath = "C:\Program Files (x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          if (-not (Test-Path $hostExePath)) {
              Write-Error "[-] CRD host executable not found after installation. The installation may have failed."
              exit 1
          }

          Write-Host "[!] Parsing the command and starting Host Service..."
          $FullCommand = $env:GOOGLE_COMMAND
          $AccessPin = $env:ACCESS_PIN
          $ComputerName = $env:COMPUTERNAME
          
          $AuthCode = [regex]::Match($FullCommand, '--code="([^"]+)"').Groups[1].Value
          if (-not $AuthCode) {
              Write-Error "[-] Could not find the Authorization Code in the provided command string."
              exit 1
          }

          $PinInput = "$AccessPin`n$AccessPin`n"
          
          $Process = Start-Process -FilePath $hostExePath -ArgumentList "--code=$AuthCode", "--redirect-url=https://remotedesktop.google.com/_/oauthredirect", "--name=$ComputerName", "-pin" -PassThru
          
          # --- NEW: Verify that the process object was created successfully ---
          if ($null -eq $Process) {
              Write-Error "[-] Start-Process failed to launch the CRD host. The process could not be started."
              exit 1
          }

          $Process.StandardInput.WriteLine($PinInput)
          $Process.StandardInput.Close()
          
          Wait-Process -Id $Process.Id
          Write-Host "[+] Host service should be configured and running."

      - name: Display Connection Info
        run: |
          echo "###################################################################"
          echo "## Chrome Remote Desktop is configured!"
          echo "###################################################################"
          echo ""
          echo "   Computer Name: ${{ env.COMPUTERNAME }}"
          echo "   Access PIN:    (The PIN you entered)"
          echo ""
          echo "   Go to https://remotedesktop.google.com/access to connect."
          echo ""
          echo "###################################################################"

      - name: Keep Runner Alive
        run: python time.py
