name: Windows - RDP with ngrok (Single Step)

on:
  workflow_dispatch:

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
      - name: Setup RDP, Tunnel, and Keep-Alive
        shell: powershell
        run: |
          # Part 1: Install Dependencies
          Write-Host "[1] Installing Dependencies..."
          Invoke-WebRequest -Uri "https://www.dropbox.com/scl/fi/ox42qglbf6fsnm9erf8cw/timelimit.py?rlkey=opyeqgum1k95kud81xlc7d66r&dl=0" -OutFile "time.py"
          pip install psutil --quiet

          # Part 2: Configure System for RDP
          Write-Host "[2] Configuring System for RDP..."
          $password = "@#Disala123456"
          Set-LocalUser -Name "runneradmin" -Password ($password | ConvertTo-SecureString -AsPlainText -Force)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          New-NetFirewallRule -DisplayName "Allow RDP" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow

          # Part 3: Setup ngrok
          Write-Host "[3] Setting up ngrok tunnel..."
          Invoke-WebRequest 'https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip' -OutFile ngrok.zip
          Expand-Archive ngrok.zip
          # Using the hardcoded token since it's the one that worked in the test
          ./ngrok/ngrok.exe config add-authtoken "1ck3S4RHUCiBfSmkyfQjK3d4MAo_6TCydiLGQ23c6aAPMUu5J"
          # Start ngrok process in the background
          Start-Process -FilePath "./ngrok/ngrok.exe" -ArgumentList "tcp", "3389" -NoNewWindow
          Start-Sleep -Seconds 15

          # Part 4: Retrieve and Display Credentials
          Write-Host "[4] Retrieving and displaying credentials..."
          $tunnel = (Invoke-RestMethod -Uri 'http://127.0.0.1:4040/api/tunnels').tunnels[0]
          $rdpAddress = $tunnel.public_url.Replace("tcp://", "")
          Write-Host "###############################################" -ForegroundColor Green
          Write-Host "## RDP Connection Details (USE NGROK)" -ForegroundColor Green
          Write-Host "###############################################" -ForegroundColor Green
          Write-Host ""
          Write-Host "   RDP Address: $rdpAddress"
          Write-Host "   Username:    runneradmin"
          Write-Host "   Password:    @#Disala123456"
          Write-Host ""
          Write-Host "   Example: 0.tcp.ngrok.io:12345"
          Write-Host "###############################################" -ForegroundColor Green

          # Part 5: Keep Alive
          Write-Host "[5] Starting keep-alive script. The job will now hang intentionally to keep the session open."
          python.exe time.py
