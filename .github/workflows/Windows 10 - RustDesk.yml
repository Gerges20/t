name: Windows - AnyDesk Remote Access

on:
  workflow_dispatch:

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
      - name: Download Keep-Alive Script
        shell: cmd
        run: |
          curl.exe -L -o time.py "https://www.dropbox.com/scl/fi/ox42qglbf6fsnm9erf8cw/timelimit.py?rlkey=opyeqgum1k95kud81xlc7d66r&dl=1"
          pip install psutil --quiet

      - name: Install and Configure AnyDesk
        shell: powershell
        run: |
          $anydeskPassword = "@#Disala123456"
          Write-Host "[!] Downloading AnyDesk..."
          Invoke-WebRequest -Uri "https://download.anydesk.com/AnyDesk.exe" -OutFile "AnyDesk.exe"
          
          Write-Host "[!] Installing AnyDesk silently..."
          Start-Process -FilePath ".\AnyDesk.exe" -ArgumentList '--install "C:\Program Files (x86)\AnyDesk" --start-with-win --silent' -Wait
          
          Start-Sleep -Seconds 10
          
          Write-Host "[!] Setting password for Unattended Access..."
          $anydeskPassword | & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-password
          
          Write-Host "[!] Retrieving AnyDesk ID (will retry up to 5 times)..."
          $anydeskId = ""
          for ($i=1; $i -le 5; $i++) {
              $anydeskId = & "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --get-id
              if ($anydeskId) {
                  Write-Host "[+] Success! AnyDesk ID is: $anydeskId"
                  break
              } else {
                  Write-Host "[-] Attempt $i failed. Retrying in 5 seconds..."
                  Start-Sleep -Seconds 5
              }
          }

          if (-not $anydeskId) {
              Write-Error "[-] Could not retrieve AnyDesk ID after multiple attempts."
              exit 1
          }
          
          echo "ANYDESK_ID=$anydeskId" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "ANYDESK_PASSWORD=$anydeskPassword" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "[+] AnyDesk setup complete."

      - name: Show AnyDesk Credentials
        run: |
          echo "###############################################"
          echo "## AnyDesk Connection Details"
          echo "###############################################"
